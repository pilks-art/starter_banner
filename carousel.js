(function () {
  const imageSlides = Array.from(document.querySelectorAll(".frame--img"));
  const navBtns = document.querySelectorAll(".arrow");
  let nextSlide;
  let slideIndex = 0;

  console.log(imageSlides, navBtns);

  //   button functionality
  navBtns.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      console.log("click", e.currentTarget);

      if (e.currentTarget.className.includes("next")) {
        console.log("next button");
      } else {
        console.log("prev button");
      }

      if (nextSlide < 0) nextSlide = slideImages.length - 1;
      if (nextSlide > slideImages.length - 1) nextSlide = 0;
    });
  });

  // display slide logic
  const showSlide = (index) => {
    imageSlides[index].classList.add("active");
  };
  const hideSlide = (index) => {
    imageSlides[index].classList.remove("active");
  };

  // loop over slides
  const carouselLoop = () => {
    imageSlides.forEach(slide => {
        slide.classList.remove("active")
    })

    if (slideIndex >= imageSlides.length) {
      slideIndex = 0;
    }
    imageSlides[slideIndex].classList.add("active");

    
    console.log(imageSlides[slideIndex]);
    
    slideIndex++;
    setTimeout(carouselLoop, 4000);
  };

  carouselLoop();
})();
